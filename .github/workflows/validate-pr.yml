name: Validate PR with Copilot CLI

on:
  workflow_dispatch:
    inputs:
      pr_url:
        description: 'URL del PR a validar (ej: https://github.com/owner/repo/pull/1)'
        required: true
        type: string

permissions:
  contents: read      # Para leer el repo actual
  pull-requests: write # Para comentar en el PR (Importante)

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # 1. Preparaci√≥n B√°sica
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse PR URL
        id: pr
        run: |
          PR_URL="${{ github.event.inputs.pr_url }}"
          if [[ ! "$PR_URL" =~ ^https://github\.com/([^/]+)/([^/]+)/pull/([0-9]+)$ ]]; then
            echo "::error::URL inv√°lida. Formato esperado: https://github.com/owner/repo/pull/123"
            exit 1
          fi
          OWNER="${BASH_REMATCH[1]}"
          REPO="${BASH_REMATCH[2]}"
          PR_NUMBER="${BASH_REMATCH[3]}"
          
          echo "owner=${OWNER}" >> $GITHUB_OUTPUT
          echo "repo=${REPO}" >> $GITHUB_OUTPUT
          echo "number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "full_repo=${OWNER}/${REPO}" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GH_PAT }}" | gh auth login --with-token
          gh auth setup-git

      # 2. Infraestructura MCP (El "puente" al otro repo)
      - name: Install Copilot CLI & MCP Server
        run: |
          npm install -g @github/copilot
          npm install -g @modelcontextprotocol/server-github

      - name: Configure MCP
        run: |
          mkdir -p ~/.config/github-copilot
          # Aqu√≠ conectamos la CLI con el servidor MCP
          cat <<EOF > ~/.config/github-copilot/mcp.json
          {
            "mcpServers": {
              "github": {
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-github"],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "${{ secrets.GH_PAT }}"
                }
              }
            }
          }
          EOF

# 3. Ejecuci√≥n de la IA (Prompt Optimizado para API Governance)
      - name: Validate PR with Copilot
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          COPILOT_GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          
          # Tus repositorios configurados
          RULES_REPO: "d1ekgo/OpenApi-AsyncApi-SPECS"
          RULES_FILE: "docs/guidelines.md"
          
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          FULL_REPO="${{ steps.pr.outputs.full_repo }}"
          
          echo "=== Iniciando Validaci√≥n de API Specs ==="
          
          set +e
          
          # PROMPT ACTUALIZADO: Detecci√≥n Din√°mica OAS/AAS + Est√°ndares Oficiales
          OUTPUT=$(copilot -p "Act√∫a como un Experto en API Governance y Est√°ndares de Integraci√≥n.
          
          Tienes configurado un servidor MCP. Ejecuta la validaci√≥n en el siguiente orden l√≥gico:

          1. **CONTEXTO CORPORATIVO:**
             Usa 'read_file' para obtener las Reglas de Dise√±o de '${RULES_FILE}' en '${RULES_REPO}'.
             
          2. **AN√ÅLISIS DEL PR:**
             Lee los archivos modificados en el PR #${PR_NUMBER} ('${FULL_REPO}'). Ignora archivos que no sean YAML/JSON de especificaci√≥n.

          3. **DETECCI√ìN Y VALIDACI√ìN (Paso Cr√≠tico):**
             Para cada archivo de especificaci√≥n encontrado, determina din√°micamente:
             
             A) **¬øEs OpenAPI (OAS)?** (Busca la clave 'openapi: 3.x')
                - Si S√ç: Valida rigurosamente contra el **Est√°ndar Oficial OpenAPI 3.0/3.1** (estructura, objetos requeridos, security schemes) Y contra las **Reglas Corporativas** del paso 1.
                
             B) **¬øEs AsyncAPI (AAS)?** (Busca la clave 'asyncapi: 2.x/3.x')
                - Si S√ç: Valida rigurosamente contra el **Est√°ndar Oficial AsyncAPI** (channels, messages, payload) Y contra las **Reglas Corporativas** del paso 1.

          4. **REPORTE:**
             Genera un reporte Markdown. NO intentes comentar, solo genera texto.
             
          Formato del Reporte:
          ## üîç Validaci√≥n de Especificaciones API

          ### üìÑ Archivo Detectado: [Nombre del archivo] ([Tipo: OAS/AAS])

          #### 1Ô∏è‚É£ Validaci√≥n Est√°ndar Oficial (Syntax & Structure)
          | Estado | Hallazgo |
          | :---: | :--- |
          | ‚úÖ/‚ùå | [Ej: Estructura v√°lida / Falta 'info.version'] |

          #### 2Ô∏è‚É£ Validaci√≥n Reglas Corporativas
          | Regla | Estado | Observaci√≥n |
          | :--- | :---: | :--- |
          | [Nombre Regla] | ‚úÖ/‚ùå | [Detalle] |

          ### üí° Acciones Requeridas
          - [Lista de correcciones]

          ---
          <sub>Validado con Copilot + MCP (Standards & Corp Rules)</sub>
          " --allow-all-tools 2>&1)

          EXIT_CODE=$?
          set -e

          echo "=== Resultado IA (Logs) ==="
          echo "$OUTPUT"

          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Copilot CLI fall√≥ al ejecutarse."
            exit $EXIT_CODE
          fi
          
          # Publicaci√≥n en el PR
          echo "=== Publicando Comentario en PR ==="
          gh pr comment "$PR_NUMBER" --body "$OUTPUT" --repo "$FULL_REPO"
          
          if echo "$OUTPUT" | grep -q "Estado: ‚ùå"; then
             echo "::warning::Se detectaron errores en la especificaci√≥n."
          fi
