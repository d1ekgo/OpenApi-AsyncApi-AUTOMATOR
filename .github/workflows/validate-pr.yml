name: BX AsyncAPI Technical Audit

on:
  workflow_dispatch:
    inputs:
      pr_url:
        description: 'URL del PR a validar (ej: https://github.com/owner/repo/pull/1)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse PR URL
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_URL="${{ github.event.inputs.pr_url }}"
          # Validar formato de URL
          if [[ ! "$PR_URL" =~ ^https://github\.com/([^/]+)/([^/]+)/pull/([0-9]+)$ ]]; then
            echo "::error::URL invÃ¡lida. Formato esperado: https://github.com/owner/repo/pull/123"
            exit 1
          fi
          OWNER="${BASH_REMATCH[1]}"
          REPO="${BASH_REMATCH[2]}"
          PR_NUMBER="${BASH_REMATCH[3]}"
          echo "owner=${OWNER}" >> $GITHUB_OUTPUT
          echo "repo=${REPO}" >> $GITHUB_OUTPUT
          echo "number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "full_repo=${OWNER}/${REPO}" >> $GITHUB_OUTPUT
          echo "Owner: ${OWNER}"
          echo "Repo: ${REPO}"
          echo "PR Number: ${PR_NUMBER}"
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GH_PAT }}" | gh auth login --with-token
          gh auth status
          gh auth setup-git
          
      - name: Install GitHub Copilot CLI
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          npm install -g @github/copilot
          copilot --version
      - name: Debug Copilot CLI
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          COPILOT_GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "=== Token validation ==="
          echo "First 10 chars of token: ${GITHUB_TOKEN:0:10}"
          
          echo ""
          echo "=== Copilot access API check ==="
          curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github+json" \
               https://api.github.com/user/copilot/access | jq '.'
          
          echo ""
          echo "=== Testing Copilot CLI ==="
          copilot -p "Say hello" 2>&1 | head -20
      - name: Validate PR with Copilot CLI
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          COPILOT_GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          MCP_TOKEN: ${{ secrets.MCP_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          FULL_REPO="${{ steps.pr.outputs.full_repo }}"
          REPO="${{ steps.pr.outputs.repo }}"
          echo "=== Starting Copilot CLI ==="
          echo "PR Number: ${PR_NUMBER}"
          echo "Repository: ${REPO}"
          # Capturar output y errores para diagnÃ³stico
          set +e
          OUTPUT=$(copilot -p "Eres un AUDITOR TÃ‰CNICO BX especializado en AsyncAPI 3.0+.
          
          TAREAS:
          1. CONTEXTO DE REGLAS:
             Usa el MCP server para leer el repo 'OpenApi-AsyncApi-SPECS' de diegobblue.
             Busca especÃ­ficamente en la carpeta 'docs' los archivos que definen las reglas de validaciÃ³n.
             Extrae y memoriza las reglas de: ESTRUCTURA, HEADERS, FORMATO, CLARIDAD Y NOMENCLATURA.
          2. ANÃLISIS DEL PR:
             Lee los archivos modificados en el PR #${PR_NUMBER} del repo ${FULL_REPO}.
             **IMPORTANTE:** Ignora archivos de configuraciÃ³n (.gitignore, README, etc.).
             CÃ©ntrate UNICAMENTE en el archivo de especificaciÃ³n de la API (.yaml, .yml o .json).
          3. EJECUCIÃ“N DE AUDITORÃA:
             Aplica las reglas extraÃ­das al archivo de especificaciÃ³n.
          4. PUBLICACIÃ“N (IMPORTANTE):
             Usa el MCP server para publicar el resultado como un comentario en el PR #${PR_NUMBER} de ${REPO}.
          REGLAS DE ORO (ESTRICTAS):
          - **IdentificaciÃ³n de Errores:** Si falta un campo obligatorio (ej. headers, channels), marca como 'MISSING' y clasifÃ­calo inmediatamente como **Severidad: error**.
          - **Evidencia:** Si encuentras un error, cita el valor actual o indica explÃ­citamente 'Campo no encontrado'.
          - **Criterio de DecisiÃ³n:**
            - 0 Errores + 0 Warnings = âœ… APROBADO (Clean) -> APPROVED
            - 0 Errores + >0 Warnings = âš ï¸ CON OBSERVACIONES -> APPROVED
            - >0 Errores = â›” RECHAZADO -> REJECTED
          FORMATO DE SALIDA (Para el comentario):
          ## ðŸ¤– Informe de AuditorÃ­a TÃ©cnica AsyncAPI BX
          ### 1) RESUMEN EJECUTIVO
          - **ESTADO:** [âœ… APROBADO / âš ï¸ CON OBSERVACIONES / â›” RECHAZADO]
          - **DECISIÃ“N FINAL:** [APROBADO / RECHAZADO]
          - **MÃ‰TRICAS:** ðŸ”´ Errores: [Cantidad] | ðŸŸ¡ Advertencias: [Cantidad]
          - **CONCLUSIÃ“N:** [Breve frase explicando la decisiÃ³n]
          ### 2) TABLAS DE CUMPLIMIENTO
          #### Estructura
          | Regla | Severidad | Estado | Hallazgo/Evidencia |
          | :--- | :--- | :---: | :--- |
          | [Nombre Regla] | [error/warning] | [âœ…/âŒ] | [Cita el valor incorrecto o 'Campo faltante'] |
          #### Headers
          | Regla | Severidad | Estado | Hallazgo/Evidencia |
          | :--- | :--- | :---: | :--- |
          | ... | ... | ... | ... |
          #### Formato
          | Regla | Severidad | Estado | Hallazgo/Evidencia |
          | :--- | :--- | :---: | :--- |
          | ... | ... | ... | ... |
          #### Claridad
          | Regla | Severidad | Estado | Hallazgo/Evidencia |
          | :--- | :--- | :---: | :--- |
          | ... | ... | ... | ... |
          #### Nomenclatura
          | Regla | Severidad | Estado | Hallazgo/Evidencia |
          | :--- | :--- | :---: | :--- |
          | ... | ... | ... | ... |
          " --allow-all-tools 2>&1)
          EXIT_CODE=$?
          set -e
          echo "=== Copilot CLI Output ==="
          echo "${OUTPUT}"
          echo "=== Exit Code: ${EXIT_CODE} ==="
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Copilot CLI failed with exit code ${EXIT_CODE}"
            exit $EXIT_CODE
          fi
