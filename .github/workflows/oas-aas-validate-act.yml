name: API Technical Audit

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # Obtiene el c√≥digo del repositorio del PR en el runner para poder ejecutar validaciones y git diff.
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Trae historial completo para comparar commits base...head del PR.
          fetch-depth: 0

      # Prepara Node.js para instalar herramientas v√≠a npm (Spectral, Copilot CLI).
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Instala Spectral CLI para linting de OpenAPI/AsyncAPI.
      - name: Install Spectral
        run: npm install -g @stoplight/spectral-cli@6.6.0

      # Autentica GitHub CLI (gh) usando un PAT para poder comentar el PR sin interacci√≥n.
      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GH_PAT }}" | gh auth login --with-token
          gh auth setup-git
      # Descarga el repo de gobernanza (rulesets/prompts) usando checkout con token (soporta repos privados).
      - name: Checkout API Governance Specs
        uses: actions/checkout@v4
        with:
          # Repo donde viven rulesets y prompts.
          repository: diegobblue/OpenApi-AsyncApi-SPECS
          # Rama/tag/commit de gobernanza (recomendado fijarlo a tag o SHA para estabilidad).
          ref: main
          # Directorio destino (evita sobrescribir el repo del PR).
          path: OpenApi-AsyncApi-SPECS
          # Token para acceder si el repo es privado.
          token: ${{ secrets.GH_PAT }}
          # No necesitas historial completo para rulesets/prompts.
          fetch-depth: 1

      # Extrae metadata del PR (autor) para reportarlo y enviarlo como m√©trica.
      - name: Get PR metadata
        id: prmeta
        run: |
          echo "author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
      # Detecta el primer archivo de spec modificado y determina si es OpenAPI o AsyncAPI.
      - name: Detect modified API spec and type
        id: spec
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          FILE=$(git diff --name-only "$BASE_SHA...$HEAD_SHA" | grep -E '\.(yaml|yml|json)$' | head -1)
          if [ -z "$FILE" ]; then
            echo "::error::No API spec file found in PR"
            exit 1
          fi
          if grep -q '^openapi:' "$FILE"; then TYPE="openapi"
          elif grep -q '^asyncapi:' "$FILE"; then TYPE="asyncapi"
          else
            echo "::error::Cannot determine spec type"
            exit 1
          fi
          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "type=$TYPE" >> $GITHUB_OUTPUT
      # Ejecuta Spectral con el ruleset correspondiente y genera un reporte JSON consumible.
      - name: Run Spectral
        id: spectral
        continue-on-error: true
        run: |
          RULESET="OpenApi-AsyncApi-SPECS/rulesets/${{ steps.spec.outputs.type }}-rules.yaml"
          spectral lint "${{ steps.spec.outputs.file }}" -r "$RULESET" -f json > spectral.json || true
          ERRORS=$(jq '[.[] | select(.severity==0)] | length' spectral.json)
          WARNINGS=$(jq '[.[] | select(.severity==1)] | length' spectral.json)
          SPECTRAL_RULES=$(jq -r '[.[] | select(.severity==0) | .code] | join(",")' spectral.json)
          echo "spectral_errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "spectral_warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "spectral_rules=$SPECTRAL_RULES" >> $GITHUB_OUTPUT
      # Instala GitHub Copilot CLI para auditor√≠a sem√°ntica.
      - name: Install GitHub Copilot CLI
        run: npm install -g @github/copilot

      # Ejecuta auditor√≠a sem√°ntica con Copilot usando prompt del repo de gobernanza.
      - name: Run Copilot semantic audit (code model)
        id: copilot
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          COPILOT_GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PROMPT="OpenApi-AsyncApi-SPECS/prompts/${{ steps.spec.outputs.type }}-prompt.md"
          copilot \
            --no-auto-update \
            --model "claude-sonnet-4.5" \
            -p "@${FILE}\n\n$(cat "$PROMPT")" \
            --allow-all-tools \
            --disable-parallel-tools-execution \
            -s \
            --stream off \
            > copilot.md
          echo "üîé Copilot raw output:"
          cat copilot.md
          COPILOT_ERRORS=$(grep "copilotErrors:" copilot.md | head -1 | sed 's/[^0-9]*//g')
          COPILOT_WARNINGS=$(grep "copilotWarnings:" copilot.md | head -1 | sed 's/[^0-9]*//g')
          if [ -z "$COPILOT_ERRORS" ]; then COPILOT_ERRORS=0; fi
          if [ -z "$COPILOT_WARNINGS" ]; then COPILOT_WARNINGS=0; fi
          COPILOT_RULES=$(grep "\[Regla Violada\]" copilot.md | cut -d':' -f2 | sed 's/^ *//' | tr '\n' ',' | sed 's/,$//')
          echo "copilot_errors=$COPILOT_ERRORS" >> $GITHUB_OUTPUT
          echo "copilot_warnings=$COPILOT_WARNINGS" >> $GITHUB_OUTPUT
          echo "copilot_rules=$COPILOT_RULES" >> $GITHUB_OUTPUT
      # Suma resultados y define PASS/FAIL.
      - name: Calculate totals
        id: totals
        run: |
          TOTAL_ERRORS=$(( ${{ steps.spectral.outputs.spectral_errors }} + ${{ steps.copilot.outputs.copilot_errors }} ))
          TOTAL_WARNINGS=$(( ${{ steps.spectral.outputs.spectral_warnings }} + ${{ steps.copilot.outputs.copilot_warnings }} ))
          STATUS="PASS"
          if [ "$TOTAL_ERRORS" -gt 0 ]; then STATUS="FAIL"; fi
          echo "total_errors=$TOTAL_ERRORS" >> $GITHUB_OUTPUT
          echo "total_warnings=$TOTAL_WARNINGS" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
      # Comenta el PR con el reporte consolidado.
      - name: Comment PR with Report
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "## ü§ñ BX API Technical Audit Report" > pr_report.md
          echo "### üîç Contexto del An√°lisis" >> pr_report.md
          echo "- **Tipo de Especificaci√≥n:** ${{ steps.spec.outputs.type }}" >> pr_report.md
          echo "- **Archivo Analizado:** ${{ steps.spec.outputs.file }}" >> pr_report.md
          echo "" >> pr_report.md
          echo "### üìä M√©tricas de Calidad" >> pr_report.md
          echo "| Fuente | Errores üî¥ | Advertencias üü° |" >> pr_report.md
          echo "| :--- | :---: | :---: |" >> pr_report.md
          echo "| **Spectral** | ${{ steps.spectral.outputs.spectral_errors }} | ${{ steps.spectral.outputs.spectral_warnings }} |" >> pr_report.md
          echo "| **Copilot** | ${{ steps.copilot.outputs.copilot_errors }} | ${{ steps.copilot.outputs.copilot_warnings }} |" >> pr_report.md
          echo "| **TOTAL** | **${{ steps.totals.outputs.total_errors }}** | **${{ steps.totals.outputs.total_warnings }}** |" >> pr_report.md
          echo "" >> pr_report.md
          echo "### üîß Hallazgos Autom√°ticos (Spectral)" >> pr_report.md
          if [ -s spectral.json ] && [ "$(cat spectral.json)" != "[]" ]; then
            jq -r '.[] | (if .severity == 0 then "‚ùå **Error**" else "‚ö†Ô∏è **Warning**" end) + "\n**Regla:** `" + .code + "`\n**Ubicaci√≥n:** `" + (.path | join(".")) + "`\n**Mensaje:** " + .message + "\n"' spectral.json >> pr_report.md
          else
            echo "‚úÖ **Spectral:** Sin hallazgos." >> pr_report.md
          fi
          echo "" >> pr_report.md
          echo "### üß† Hallazgos Sem√°nticos (Copilot)" >> pr_report.md
          if [ -f copilot.md ]; then
            cat copilot.md >> pr_report.md
          else
            echo "No se gener√≥ reporte sem√°ntico." >> pr_report.md
          fi
          echo "---" >> pr_report.md
          if [ "${{ steps.totals.outputs.status }}" == "FAIL" ]; then
            echo "### ‚õî **ESTADO FINAL: RECHAZADO**" >> pr_report.md
            echo "> Se detectaron **${{ steps.totals.outputs.total_errors }} errores bloqueantes** totales." >> pr_report.md
          else
            echo "### ‚úÖ **ESTADO FINAL: APROBADO**" >> pr_report.md
          fi
          gh pr comment "${{ github.event.pull_request.number }}" \
            --repo "${{ github.repository }}" \
            --body-file pr_report.md
      # Env√≠a m√©tricas a Google Sheets v√≠a webhook.
      - name: Send metrics to Google Sheets
        if: always()
        env:
          SHEETS_WEBHOOK_URL: ${{ secrets.SHEETS_WEBHOOK_URL }}
        run: |
          curl -X POST "$SHEETS_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "repo": "${{ github.repository }}",
              "pr_number": "${{ github.event.pull_request.number }}",
              "pr_author": "${{ steps.prmeta.outputs.author }}",
              "api_type": "${{ steps.spec.outputs.type }}",
              "spectral_errors": "${{ steps.spectral.outputs.spectral_errors }}",
              "spectral_warnings": "${{ steps.spectral.outputs.spectral_warnings }}",
              "copilot_errors": "${{ steps.copilot.outputs.copilot_errors }}",
              "copilot_warnings": "${{ steps.copilot.outputs.copilot_warnings }}",
              "total_errors": "${{ steps.totals.outputs.total_errors }}",
              "total_warnings": "${{ steps.totals.outputs.total_warnings }}",
              "status": "${{ steps.totals.outputs.status }}",
              "spectral_rules_list": "${{ steps.spectral.outputs.spectral_rules }}",
              "copilot_rules_list": "${{ steps.copilot.outputs.copilot_rules }}"
            }'
